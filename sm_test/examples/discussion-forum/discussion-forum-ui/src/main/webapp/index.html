<!DOCTYPE html>
<html>
<head>
    <title>Discussion Forum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>
<body>

<div id="main" class="container">
    <h1><span id="heading" >Edifecs Discussion Forum</span></h1>

    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <ul class="nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li id="lCategory"><a href="#" onclick='displayCategories()'>Categories</a></li>
                    <li><a href="#">Members</a></li>
                    <li><a href="#">Register</a></li>
                    <li><a href="#">Search</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="divCategories">
        <button type="button" class="btn btn-default navbar-btn" id="addCategoryBtn" onclick="displayAddMsgPopup($('#divAddCat'), $('#addCategoryBtn'), false)">Add Category</button>

        <div id="divAddCat" style="display:none">
            <fieldset>
                <legend>Add Category</legend>
                <form class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <label> Name </label>
                        <input type="text" id="category_name" />
                        <label> Description </label>
                        <textarea id="category_desc" style="width: 700px; height: 150px;" rows="10"  cols="250"> </textarea>
                    </div>
                    <button type="submit" onclick="addCategory()" class="btn btn-default">Submit</button>
            </fieldset>
            </form>
        </div>
        <table id="tblCategory" class="table table-striped">
            <thead>
            <td><b>Category</b></td>
            <td><b>Description</b></td>
            <td><b>Created By</b></td>
            <td><b>Last Activity </b></td>
            </thead>
        </table>
    </div>
    <ol id="olTopics" class="breadcrumb">
        <li id="liCategory" >

        </li>
        <li id="liTopic" >

        </li>
    </ol>

    <div id="divTopics" style="display:none">



        <button type="button" class="btn btn-default navbar-btn" id="addTopicBtn" onclick="displayAddMsgPopup($('#divAddTopic'), $('#addTopicBtn'), false)">Add Topic</button>

        <div id="divAddTopic" style="display:none">
            <fieldset>
                <legend>Add Topic</legend>
                <form class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <label> Name </label>
                        <input type="text" id="topic_name" style="width: 700px;" />

                    </div>
                    <button type="submit" onclick="addTopic()" class="btn btn-default" style="margin-top:20px" >Submit</button>
            </fieldset>
            </form>
        </div>
        <table id="tblTopics" class="table table-striped">
            <thead>
            <td><b>Subject</b></td>
            <td><b>Last Activity</b></td>
            <td><b>Created By</b></td>
            </thead>
        </table>

    </div>
    <div id="divReplies" style="display:none">

        <button type="button" class="btn btn-default navbar-btn" id="addMessageBtn" onclick="displayAddMsgPopup($('#divAddMsg'), $('#addMessageBtn'), false)">Add Message</button>
        <div id="divAddMsg" style="display:none">
            <form class="navbar-form navbar-left" role="search">
                <div class="form-group">
                    <textarea id="msg" style="width: 700px; height: 150px;" rows="10"  cols="250"> </textarea>
                </div>
                <button type="submit" onclick="addMessage()" class="btn btn-default">Submit</button>
            </form>
        </div>

        <table id="tblReplies" class="table table-striped">
            <thead>
            <td><b>Last Activity/Created By</b></td>
            <td><b>Message</b></td>

            </thead>
        </table>
    </div>

</div>

<script type="text/javascript">
    var topic_id;
    var category_id;
    var categoryName;
    var topicName;
    $(document).ready(function () {

        $.ajax({url:"/rest/service/discussion-forum-service/discussion-forum.greeting",
            success:function(result){

                if(result.error == undefined ) {

                    $("#heading").text(result.data);
                }
            }
        });

        displayCategories();

    });

    function displayCategories() {
        $("#liTopic").text("");
        $("#liCategory").text("");
        $("#tblCategory").find("tr:gt(0)").remove();
        $.getJSON("/rest/service/discussion-forum-service/discussion-forum.getCategories",
                function (json) {
                    json = json.data;
                    var tr;
                    //$('#tblCategory').empty();
                    for (var i = 0; i < json.length; i++) {
                        tr = $('<tr/>');
                        tr.append("<td><a href='#' onclick='displayTopics(" + json[i].id + ",\""+ json[i].name +"\")'>" + json[i].name + "</a></td>");
                        tr.append("<td>" + json[i].description + "</td>");
                        tr.append("<td>" + json[i].createdBy + "</td>");
                        tr.append("<td>" + json[i].creationDate.year +"/"+ (json[i].creationDate.month+1) + "/" +json[i].creationDate.dayOfMonth + "</td>");
                        $('#tblCategory').append(tr);
                    }
                });
        $('#divTopics').hide();
        $('#divReplies').hide();
        $('#divCategories').show();

    }
    function displayTopics(categoryId, name) {
        $("#liCategory").text(name);

        category_id = categoryId;
        $("#tblTopics").find("tr:gt(0)").remove();
        $.getJSON("/rest/service/discussion-forum-service/discussion-forum.getTopics?categoryId=" + categoryId,
                function (json) {
                    json = json.data;
                    var tr;

                    for (var i = 0; i < json.length; i++) {
                        tr = $('<tr/>');
                        tr.append("<td><a href='#' onclick='displayReplies(" + json[i].id + ",\""+ json[i].subject +"\")' >" + json[i].subject + "</a></td>");
                        tr.append("<td>" + + json[i].creationDate.year +"/"+ (json[i].creationDate.month+1) + "/" +json[i].creationDate.dayOfMonth  + "</td>");
                        tr.append("<td>" + json[i].createdBy + "</td>");
                        $('#tblTopics').append(tr);
                    }


                });

        $('#divTopics').show();
        $('#divCategories').hide();
        $('#divReplies').hide();
    }

    function displayReplies(topicId, name) {
        $("#liTopic").text(" >> " +name);
        topicName = name;
        topic_id=topicId;
        $("#tblReplies").find("tr:gt(0)").remove();
        $.getJSON("/rest/service/discussion-forum-service/discussion-forum.getReplies?topicId=" + topicId +"&start=0",
                function (json) {
                    json = json.data;
                    var tr;

                    for (var i = 0; i < json.length; i++) {
                        tr = $('<tr/>');
                        tr.append("<td>" + json[i].createdBy +" / " +json[i].replyDate +"</td>");
                        tr.append("<td>" + json[i].message + "</td>");

                        $('#tblReplies').append(tr);
                    }


                });
        $('#divTopics').hide();
        $('#divCategories').hide();
        $('#divReplies').show();

    }

    function displayAddMsgPopup(divId, btnId, toggle) {
        if(toggle == false) {
            divId.show();
            btnId.hide();
        } else {
            divId.hide();
            btnId.show();
        }
    }

    function addMessage() {

        $.ajax({url:"/rest/service/discussion-forum-service/discussion-forum.addReply?topicId="+topic_id+"&message="+ $("#msg").val(),
            success:function(result){

                if(result.error == undefined ) {
                    $("#msg").val("");
                    displayReplies(topic_id,topicName);
                    $('#divAddMsg').hide();
                    $("#addMessageBtn").show();
                } else {
                    alert(result.error);
                }
            },
            error:
                    function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status);
                        alert(thrownError);
                    }
        });

    }

    function addCategory() {

        $.ajax({url:"/rest/service/discussion-forum-service/discussion-forum.createCategory?name="+$("#category_name").val()+"&description="+ $("#category_desc").val(),
            success:function(result){
                if(result.error == undefined ) {
                    displayCategories();
                    $("#category_name").val("");
                    $("#category_desc").val("");
                    displayAddMsgPopup($('#divAddCat'), $("#addCategoryBtn"), true);

                } else {
                    alert(result.error);
                }
            },
            error:
                    function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status);
                        alert(thrownError);
                    }
        });

    }

    function addTopic() {

        $.ajax({url:"/rest/service/discussion-forum-service/discussion-forum.createTopic?categoryId="+category_id+"&topicSubject="+ $("#topic_name").val(),
            success:function(result){
                if(result.error == undefined ) {
                    $("#topic_name").val("");
                    displayTopics(category_id);
                    displayAddMsgPopup($('#divAddTopic'), $("#addTopicBtn"), true);

                } else {
                    alert(result.error);
                }
            },
            error:
                    function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status);
                        alert(thrownError);
                    }
        });

    }

</script>
</body>
</html>

